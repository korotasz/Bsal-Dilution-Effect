"0","#| label: hostCompetence"
"0","#| fig-width: 100%"
"0","#| echo: false"
"0","#| eval: true"
"0",""
"0","## Observed species prevalence"
"0","prev <- d %>%"
"0","  group_by(scientific) %>%"
"0","  mutate(ncas_Bsal = sum(BsalDetected == 1), # number of observed Bsal+ cases"
"0","         npop = sum(individualCount)) %>% # pop size (total # individuals/spp.)"
"0","  drop_na(date) %>%"
"0","  ungroup() %>%"
"0","  mutate(Bsal_prev = (ncas_Bsal/npop)*100) %>% # prevalence as a percentage"
"0","  dplyr::select(scientific, susceptibility, ncas_Bsal, Bsal_prev, npop) %>%"
"0","  unique() %>%"
"0","  dplyr::mutate(row_id = row_number()) %>%"
"0","  relocate(row_id, .before = scientific)"
"0",""
"0",""
"0","# Use binconf function to sample binomial distribution and get CIs for prevalence"
"0","bsal_ci <- binconf(prev$ncas_Bsal, prev$npop, method = ""exact"", return.df = T)"
"0","bsal_bayesci <- binom::binom.bayes(x = prev$ncas_Bsal, n = prev$npop, type = ""highest"", tol = 1e-9, maxit = 1000)"
"0",""
"0","# Convert binconf point estimates + CIs to percentages for plotting"
"0","bsal_ci <-  bsal_ci %>%"
"0","  plyr::mutate(PointEst = round((PointEst*100), 1),"
"0","               Lower = round((Lower*100), 1),"
"0","               Upper = round((Upper*100), 1)) %>%"
"0","  dplyr::mutate(row_id = row_number()) %>%"
"0","  relocate(row_id, .before = PointEst)"
"0",""
"0","# Convert bayesian estimates + CIs to percentages for plotting"
"0","bsal_bayesci <-  bsal_bayesci %>%"
"0","  plyr::mutate(mean = round((mean*100), 1),"
"0","               lower = round((lower*100), 1),"
"0","               upper = round((upper*100), 1)) %>%"
"0","  dplyr::mutate(row_id = row_number()) %>%"
"0","  relocate(row_id, .before = method)"
"0",""
"0",""
"0","# Join with original 'prev' dataset, so we can plot actual vs expected"
"0","prev <- prev %>%"
"0","  left_join(., bsal_ci, by = ""row_id"") %>%"
"0","  left_join(., bsal_bayesci, by = ""row_id"") %>%"
"0","  plyr::arrange(., scientific)"
"0",""
"0","prev_bayes_plot <- ggplot(prev, aes(scientific, sapply(mean, FUN = function(x) ifelse(x == 0.0, round(x, 0), x)),"
"0","                                          colour = susceptibility,"
"0","                                          label = paste(mean,""%""))) +"
"0","  geom_point(size = 5) +"
"0","  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.5, linewidth = 1) +"
"0","  geom_text(aes(colour = susceptibility, x = (as.numeric(scientific) + 0.05), y = upper + 5),"
"0","            size = 6, fontface = ""bold"", alpha = 0.75) +"
"0","  coord_flip(clip = ""off"") +"
"0","  ylab(""Disease prevalence (%)"") +"
"0","  xlab(""Species"") +"
"0","  scale_colour_manual(name = ""Susceptibility"","
"0","                      values = c(""#548078"", ""#E3A630"", ""#b30000""),"
"0","                      labels = c(""Resistant"", ""Tolerant"", ""Susceptible""),"
"0","                      guide = ""none"") +"
"0","  scale_y_continuous(labels = seq(0, 50, 10),"
"0","                     breaks = seq(0, 50, 10),"
"0","                     limits = c(0, 51)) +"
"0","  scale_x_discrete(expand = expansion(mult = c(0, 0.01), add = c(1, 0.25))) +"
"0","  ak_theme + theme(axis.text.y = element_text(face = ""italic""),"
"0","                   legend.title = element_blank())"
"0",""
"0","prev_bayes_plot"
"0",""
