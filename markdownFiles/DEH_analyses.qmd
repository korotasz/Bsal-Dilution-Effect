---
title: "*Batrachochytrium salamandrivorans* prevalence is associated positively with host density and negatively with host richness across European amphibian communities"
author: Alexis Korotasz 
date: "`r Sys.Date()`"
format: 
  html:
    theme: 
      light: minty
      dark: darkly
    link-external-newwindow: true
    link-external-icon: true
    embed-resources: true
    smooth-scroll: true
    anchor-sections: true
    number-sections: false
    code-fold: true
    code-tools: true
    code-copy: hover
    code-summary: "code </>"
    code-overflow: wrap
    code-links:
      - text: Project Repository
        icon: github
        href: https://github.com/korotasz/Chapter-2-Analyses
    toc: true
    toc-location: left
    toc_depth: 6
    freeze: auto
    fig-align: center
    fig-cap-location: bottom
    tbl-cap-location: top
    css: bootstrap.css
    lightbox: true

  


---
```{r}
#| echo: false
#| output: false

## Set working directory 
knitr::opts_knit$set(root.dir = dirname("C:/Users/alexi/Development/Chapter-2-Analyses/markdownFiles"))

## Load packages that will be used throughout -- others will be loaded and unloaded througout the document
library(pacman)
library(extrafontdb)
library(extrafont) 
extrafont::loadfonts(device = "all", quiet = T) # plot fonts 
## Packages --------------------------------------------------------------------
### > Visualization Packages----------------------------------------------------
pckgs <- c("ggsignif", # adds labels to significant groups
             "ggpubr", # stat_compare_means()
            "ggbreak", # create axis breaks in ggplots
             "gtools", # signif. value styling
             "ggtext", # for text type/arrangements w/ ggplot2
           "Rttf2pt1", # to use with the extrafont package
           "ggthemes", # contains 'scales', 'themes', and 'geoms' packages
          "grDevices", # saves high quality svg, pdf, and ps files
           "graphics", # dependency of grDevices
            "cowplot", # arranging plots/figs
          "gridExtra", # arranging plots/figs
          "patchwork", # arranging plots/figs
         "hrbrthemes", # plot colors
       "RColorBrewer", # plot colors
            "viridis", # plot colors
           "eurostat", # obtain spatial data from europe
            "geodata", # obtain geographic data (world map)
      "rnaturalearth", # obtain spatial polygons that can be used with sf
                 "sf", # mapping
          "ggspatial", # north arrow and scale bar
            "mapproj", # apply map projection
       "multcompView", # cld.emmGrid()
             "sjPlot", # plot_model(), tab_model()
           #     "ragg", # converts plots to tiff files
           # "webshot2", # converts html files to png
           #   "magick", # image_read() -- needed for cowplot::draw_image
              "Hmisc", # binconf() provides CI of binomial distribution
### > Markdown Packages --------------------------------------------------------
          "htmltools", # visualizes model outputs as html tables
          "latex2exp", # allows use of LaTeX in R
               "glue", # allows concatenation of LaTeX and R syntax
           # "ggiraphExtra", # make an interactive plot
         "kableExtra", # table styling
### > Analysis Packages --------------------------------------------------------
          "tidyverse", # data wrangling/manipulation
            "glmmTMB", # glmmTMB()
           "multcomp", # glht()
            "emmeans", # lsmeans()
                "car", # Anova()
             "DHARMa", # simulateResiduals(), testZeroInflation(), testDispersion()
              "MuMIn", # model.sel()
          "ggeffects", # ggpredict()
               "epiR", # calculate prevalence & CIs
              "binom", # credible intervals
             "sjmisc"  # data and variable transformation
)

## Load packages
pacman::p_load(pckgs, character.only = T)

## Functions -------------------------------------------------------------------
map_bounds <- function(x1, x2, y1, y2, crs){
  df <- data.frame(Lon = c(x1, x2),
                   Lat = c(y1, y2)) %>%
    st_as_sf(., coords = c("Lon", "Lat"), crs = 4326) %>%
    st_transform(., crs)

  out_df <- data.frame(x1 = sf::st_coordinates(df)[1,1],
                       x2 = sf::st_coordinates(df)[2,1],
                       y1 = sf::st_coordinates(df)[1,2],
                       y2 = sf::st_coordinates(df)[2,2])
  return(out_df)

}

flip <- function(data) {
  new <- data[rev(rownames(data)), ]
  rownames(new) <- NULL
  new
}

## Read in .csv files and prep data --------------------------------------------
## All data -- not meant for analyses, just visualization.
d <- read.csv("BsalData_all.csv", header = T, encoding = "UTF-8") %>%
  filter(continent == "Europe") %>% 
  # transform vars
  mutate(logsppAbun = log(sppAbun + 1),
         logsiteAbun = log(siteAbun + 1),
         scientific = as.factor(scientific),
         susceptibility = as.factor(susceptibility)) %>%
  relocate(c(logsppAbun, logsiteAbun), .after = sppAbun)


## 'dcbind' dataset is what will be used to run our models
dcbind_all <- read.csv("Bsal_cbind_all.csv", header = T, encoding = "UTF-8") %>%
  filter(continent == "Europe") %>% 
  # transform vars
  mutate(logsppAbun = log(sppAbun + 1),
         logsiteAbun = log(siteAbun + 1),
         scientific = as.factor(scientific),
         susceptibility = as.factor(susceptibility)) %>%
  relocate(c(logsppAbun, logsiteAbun), .after = sppAbun)

dcbind_scaled <- dcbind_all %>% 
  ## Data prep for cbind models: drop rows with NA vals in weather data & scale relevant vars
  #   bio1_wc = "annual mean temperature" | bio12_wc = annual precipitation
  tidyr::drop_na(., any_of(c("temp_d", "sMoist_d", "tmin_wc:bio1_wc", "bio12_wc"))) %>%
  mutate_at(c("temp_d", "sMoist_d",
              "bio1_wc", "bio12_wc", "tavg_wc", "prec_wc"),
            ~(scale(., center = T, scale = T %>% as.numeric))) %>%
  mutate(year = year(date),
         locality = case_when(is.na(locality) ~ ADM2,
                              TRUE ~ locality))


## Define general ggplot theme for plot uniformity -----------------------------
ak_theme <- theme_ipsum(base_family = "Segoe UI Light") +
  theme(axis.text.x = element_text(size = 26),
        axis.title.x = element_text(size = 34, hjust = 0.5,
                                    margin = margin(t = 10, r = 0, b = 0, l = 0),
                                    face = "plain"),
        axis.text.y = element_text(size = 26, face = "italic"),
        axis.title.y = element_text(size = 34, hjust = 0.5,
                                    margin = margin(t = 0, r = 15, b = 0, l = 5),
                                    face = "plain"),
        axis.ticks.length = unit(.25, "cm"),
        axis.ticks = element_blank(),
        plot.tag = element_text(size = 36, face = "bold"),
        plot.title = element_text(size = 42, hjust = 0.5, face = "plain"),
        plot.subtitle = element_markdown(size = 12, face = "plain"),
        # plot.margin = margin(1, 1, 1.5, 1.2, "cm"),
        plot.caption = element_markdown(hjust = 1, size = 14, face = "plain"),
        plot.caption.position = "plot",
        legend.position = "top",
        legend.key.size = unit(2,"cm"),
        legend.text = element_text(size = 28, hjust = -1),
        legend.title = element_text(size = 28, face = "bold"),
        panel.border = element_blank(),
        panel.background = element_blank(),
        panel.spacing.y = unit(1.5,"cm"),
        strip.text = element_text(size = 14, face = "bold", hjust = 0.5),
        axis.line = element_line(color = 'black'))




## Clean labels for model output in a table ------------------------------------
nicelabs <- c(`(Intercept)` = "Intercept",
              richness = "Relative richness",
              iucn_rich = "Richness estimate (IUCN)",
              locality_rich = "Richness estimate (local species pool)",
              logsppAbun = "log(Species abundance)",
              logsiteAbun = "log(Site abundance)",
              "richness:logsiteAbun" = "Richness:log(Site abundance)",
              temp_d = "Temperature",
              soilM_d = "Soil moisture",
              "temp_d:sMoist_d" = "Temp:Soil moisture")

```

## Abstract

1.  Amphibians are one of the most threatened vertebrate taxa on the planet and a prominent driver of these declines is chytridiomycosis, a fungal disease caused by *Batrachochytrium dendrobatidis* (Bd) and, more recently, *Batrachochytrium salamandrivorans* (Bsal). Since its discovery, the known range of Bsal has rapidly expanded, devastating salamander populations across Europe.
2.  Research thus far has shown that temperature and moisture play a major role in the persistence of Bsal in the environment and that susceptibility to Bsal varies among species. However, little is known about host community composition and richness as drivers of Bsal prevalence.
3.  To investigate how community structure (i.e., host abundance and richness) affects Bsal prevalence, we compiled and analyzed publicly available data on the swabbing of **2,909 amphibians** from **45 Bsal positive sites** across Europe comprised of some combination of **14 unique species**.
4.  We show that the amphibian-Bsal system meets several pre-requisites for a dilution effect, which describes a negative host biodiversity-disease relationship. Namely, there is variation in host competence and, despite Bsal being associated with host declines, the most abundant species were the least resistant and most competent hosts of Bsal. On average across all communities, Bsal prevalence was associated positively with host density and negatively with host richness, supporting density-dependent transmission and a dilution effect. Additionally, a dilution effect was observed for fire salamanders (*Salamandra salamandra*), the species experiencing the greatest declines from Bsal in Europe. However, for fire salamanders, Bsal prevalence was associated negatively with host density, presumably because Bsal is causing population declines in this species.
5.  These results suggest that conserving salamander species could reduce Bsal transmission and Bsal-induced salamander population declines.

**Keywords:** amphibian, Bsal, chytridiomycosis, dilution effect, disease ecology, salamander

## Data exploration
### Checking for outliers
```{r}
#| label: outlierCheck
#| echo: true

posSites <- dcbind_all %>% 
  filter(posSite == "1")

## Reduce data size to capture most important variables
posSites_reduced <- posSites %>% 
  separate_wider_delim(., cols = date, delim = "-", names = c("year", "month", "day")) %>% 
  mutate(year = as.numeric(year),
         month = as.numeric(month),
         day = as.numeric(day)) %>% 
  subset(., select = c(Site, year, month, day, richness, iucn_rich, locality_rich, logsppAbun, logsiteAbun, nPos_all, nNeg_all, temp_d, sMoist_d, bio1_wc, bio12_wc))

## Call boxplot function to check for outliers
DataExplorer::plot_boxplot(posSites_reduced, by = "Site")

## Look closer at 'nPos_all'
rstatix::identify_outliers(posSites_reduced, nPos_all) # Be aware of the extreme outlier -- not going to do anything about it now

```
### Static Maps

Europe polygons were re-projected to EPSG:27704 (WGS84/Equi7 Europe) for mapping purposes. These projections were made as a part of [a larger project](https://github.com/TUW-GEO/Equi7Grid)/[paper](https://doi.org/10.1016/j.cageo.2014.07.005) to optimize handling remote-sensing data, with each continent having their own centroid.

```{r}
#| label: staticMaps
#| echo: false
#| fig-show: hold
 


epsg27704 <- crs('+proj=aeqd +lat_0=53 +lon_0=24 +x_0=5837287.81977 +y_0=2121415.69617 +datum=WGS84 +units=m +no_defs')

obs <- d %>%
  dplyr::select(country, ADM0, Lat, Lon, BsalDetected, individualCount) %>%
  plyr::mutate(BsalDetected = as.factor(dplyr::recode(BsalDetected,
                                                      "1" = "Bsal positive",
                                                      "0" = "Bsal negative"))) %>%
  st_as_sf(., coords = c("Lon", "Lat"), crs = 4326) %>%
  mutate(jittered = sf::st_jitter(geometry, 0.25)) %>%
  arrange(BsalDetected)


# summarise data
sampSize <- obs %>%
  group_by(country) %>%
  summarise(n = n())

# Get the coordinates of each country
country_lookup <- read.csv("markdownFiles/countries.csv", stringsAsFactors = F)
names(country_lookup)[1] <- "country_code"


# Combine summarised data
mapLabels <- merge(x = sampSize, y = country_lookup,
                   by.x = "country", by.y = "name", all.x = T) %>%
  st_as_sf(., coords = c("longitude", "latitude"), crs = 4326)

# Obtain world map
worldmap <- ne_countries(scale = "medium", type = "map_units", returnclass = "sf") %>%
  st_transform(., crs = 4326)

# Summarise the number of observations from each Bsal+ country and plot individual points on a map.
obs <- obs %>%
  filter(country == "Germany" | country == "Spain") %>%
  st_transform(., crs = epsg27704)

# Create country labels for maps
labs <- mapLabels %>%
  filter(country == "Germany" | country == "Spain") %>%
  st_transform(geometry, crs = epsg27704)

# Subset country polygons for base maps
europe <- worldmap %>%
  filter(continent == "Europe" & !name %in% c("Russia")) %>%
  st_transform(., crs = epsg27704)

# Subset polygons for Bsal+ countries
countries <- worldmap %>%
  filter(sovereignt %in% c("Spain", "Germany")) %>%
  st_transform(., crs = epsg27704)


# Europe -----------------------------------------------------------------------
eu <-  labs %>%
  filter(country == "Germany" | country == "Spain") %>%
  # mutate(total = sum(n)) %>%
  plyr::mutate(label = paste(country))


#map_bounds(-8, 15, 34, 56, crs = epsg27704)

europe_map <- ggplot() +
  geom_sf(data = europe, col = "gray40", fill = "#ECECEC", show.legend = F) +
  geom_sf(data = countries, aes(fill = sovereignt), col = "gray40", fill = "#B2BEB5", show.legend = F) +
  geom_sf(data = obs, aes(geometry = jittered, fill = BsalDetected, shape = BsalDetected),
          alpha = 0.3, size = 4, stroke = 1, color = "gray30", show.legend = "point") +
  geom_sf_label(data = eu, aes(label = paste(label)),
                size = 7, fontface = "bold", label.size = NA, alpha = 0.5) +
  scale_fill_manual(values = c("gray40", "#b30000"), guide = "none") +
  scale_shape_manual(values = c(21, 24), guide = "none") +
  coord_sf(xlim = c(2903943, 5277030), # c(-9, 15)
           ylim = c(625595.8, 2491036)) + # c(34, 56)
  annotation_scale(location = "br", width_hint = 0.5, text_cex = 2.5, text_face = "plain",
                   pad_y = unit(0.5, "cm")) +
  annotation_north_arrow(location = "bl", which_north = "true",
                         height = unit(2.5, "cm"), width = unit(2.5, "cm"),
                         pad_x = unit(0.25, "cm"), pad_y = unit(0.25, "cm"),
                         style = north_arrow_fancy_orienteering(line_width = 1.8, text_size = 18)) +
  ak_theme + theme(legend.title = element_blank(),
                   legend.position = "top",
                   legend.spacing = unit(1, 'cm'),
                   legend.key.size = unit(1,"cm"),
                   legend.text = element_text(size = 38, hjust = 0,
                                              margin = margin(l = 5, r = 30, unit = "pt")),
                   axis.text.x = element_text(size = 38, angle = 45, vjust = 0.5),
                   axis.title.x = element_blank(),
                   axis.text.y = element_text(size = 38, face = "plain"),
                   axis.title.y = element_blank()) +
  guides(fill = guide_legend(override.aes = list(color = c("gray40", "#b30000"),
                                                 shape = c(21, 24),
                                                 size = c(7, 7),
                                                 alpha = c(1, 1))))


europe_map
# Germany ----------------------------------------------------------------------
g <- mapLabels %>% filter(country == "Germany") %>%
  plyr::mutate(label = paste(country, " (n = ", n, ")", sep = ""))

#map_bounds(7.5, 14.5, 46.5, 55.5, crs = epsg27704)

deu_map <- ggplot() +
  geom_sf(data = europe, col = "gray40", fill = "#ECECEC", show.legend = F) +
  geom_sf(data = countries, aes(fill = sovereignt), col = "gray40", fill = "#B2BEB5", show.legend = F) +
  # geom_sf_label(data = g, aes(label = paste(label)),  nudge_x = 400000,  nudge_y = 430000,
  #               size = 14, fontface = "bold", label.size = NA, alpha = 0.5) +
  geom_sf(data = obs, aes(geometry = jittered, fill = BsalDetected, shape = BsalDetected),
          alpha = 0.3, size = 4, stroke = 1, color = "gray30", show.legend = "point") +
  scale_fill_manual(values = c("gray40", "#b30000"), guide = "none") +
  scale_shape_manual(values = c(21, 24), guide = "none") +
  coord_sf(xlim = c(4452875, 5238551), # c(7.5, 14.5)
           ylim = c(1540088, 2435744)) + # c(46.5, 55.5)
  annotation_scale(location = "br", width_hint = 0.5, text_cex = 2.5, text_face = "plain",
                   pad_y = unit(0.5, "cm")) +
  annotation_north_arrow(location = "bl", which_north = "true",
                         height = unit(2.5, "cm"), width = unit(2.5, "cm"),
                         pad_x = unit(0.25, "cm"), pad_y = unit(0.25, "cm"),
                         style = north_arrow_fancy_orienteering(line_width = 1.8, text_size = 18)) +
  ak_theme + theme(legend.title = element_blank(),
                   legend.position = "top",
                   legend.spacing = unit(1, "cm"), # Space legend labels
                   legend.key.size = unit(1,"cm"),
                   legend.text = element_text(size = 32, hjust = 0,
                                              margin = margin(l = 5, r = 30, unit = "pt")),
                   axis.text.x = element_text(size = 32, angle = 45, vjust = 0.5),
                   axis.title.x = element_blank(),
                   axis.text.y = element_text(size = 32, face = "plain"),
                   axis.title.y = element_blank()) +
  guides(fill = guide_legend(override.aes = list(color = c("gray40", "#b30000"),
                                                 shape = c(21, 24),
                                                 size = c(5, 5),
                                                 alpha = c(1, 1))))


#### c. Spain ------------------------------------------------------------------
s <- mapLabels %>% filter(country == "Spain") %>%
  plyr::mutate(label = paste(country, " (n = ", n, ")", sep = ""))

#map_bounds(-9, 3.75, 34.25, 46.5, crs = epsg27704)

esp_map <- ggplot() +
  geom_sf(data = europe, col = "gray40", fill = "#ECECEC", show.legend = F) +
  geom_sf(data = countries, aes(fill = sovereignt), col = "gray40", fill = "#B2BEB5", show.legend = F) +
  # geom_sf_label(data = s, aes(label = paste(label)), nudge_x = 400000, nudge_y = 250000,
  #               size = 12, fontface = "bold", label.size = NA, alpha = 0.5) +
  geom_sf(data = obs, aes(geometry = jittered, fill = BsalDetected, shape = BsalDetected),
          alpha = 0.3, size = 4, stroke = 1, color = "gray30", show.legend = "point") +
  scale_fill_manual(values = c("gray40", "#b30000"), guide = "none") +
  scale_shape_manual(values = c(21, 24), guide = "none") +
  coord_sf(xlim = c(2860148, 4298549), # c(-9, 4)
           ylim = c(690856.1, 1606424)) + # c(34.25, 46.5)
  annotation_scale(location = "br", width_hint = 0.5, text_cex = 2.5, text_face = "plain",
                   pad_y = unit(0.5, "cm"), pad_x = unit(3.25, "cm")) +
  annotation_north_arrow(location = "bl", which_north = "true",
                         height = unit(2.5, "cm"), width = unit(2.5, "cm"),
                         pad_x = unit(0.25, "cm"), pad_y = unit(0.25, "cm"),
                         style = north_arrow_fancy_orienteering(line_width = 1.8, text_size = 18)) +
  ak_theme + theme(legend.title = element_blank(),
                   legend.position = "top",
                   legend.spacing = unit(1, "cm"), # Space legend labels
                   legend.key.size = unit(1,"cm"),
                   legend.text = element_text(size = 28, hjust = 0,
                                              margin = margin(l = 5, r = 30, unit = "pt")),
                   axis.text.x = element_text(size = 28, angle = 45, vjust = 0.5),
                   axis.title.x = element_blank(),
                   axis.text.y = element_text(size = 28, face = "plain"),
                   axis.title.y = element_blank()) +
  guides(fill = guide_legend(override.aes = list(color = c("gray40", "#b30000"),
                                                 shape = c(21, 24),
                                                 size = c(5, 5),
                                                 alpha = c(1, 1))))




```


